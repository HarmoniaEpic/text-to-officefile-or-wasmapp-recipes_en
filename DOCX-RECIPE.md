# **DOCX Auto-Generation Page Recipe v4.0**
**A Complete Guide to AI-Powered One-Click Download Page Generation**

---

## **üìå About This Recipe**

This is a complete set of instructions for automatically creating a **single HTML file** that lets a generative AI build and download a Word document (.docx) in the browser based on a user's instructions.

### **v4.0 Highlights**
- üéØ Clarified implementation rules with explicit priority levels
- üñºÔ∏è Image placeholders are **optional** (use them only when the request explicitly asks)
- üìù Covers advanced Word-specific features
- üîç Includes error-handling steps and concrete examples
- üìä Progressive implementation examples for easy learning

### **Important Changes (v3.x ‚Üí v4.0)**
- **Default behavior changed**: image placeholders are no longer added automatically
- **Explicit instruction required**: if you need images, the request must clearly say so (e.g., "place an image")
- **Simplicity first**: by default, documents are clean and text-only

---

## **üö® Implementation Rules (in Priority Order)**

### **üî¥ Level 1: Absolutely Prohibited Changes (Do Not Modify/Delete)**

The following elements must **never** be changed:

#### **1.1 Installation of the `python-docx` Library**
```javascript
await pyodide.loadPackage("micropip");
await pyodide.runPythonAsync(`
    import micropip
    await micropip.install('python-docx')
`);
```

**Why this is mandatory:**
- `python-docx` is the external library used to generate Word documents.
- It is **not** included by default in the browser's Pyodide environment.
- You must install it at runtime using `micropip`.
- **Guaranteed error if removed**: `ModuleNotFoundError: No module named 'docx'`

#### **1.2 Error Overlay HTML/CSS/JavaScript**
- The HTML structure for the error overlay (`<div id="error-overlay">`)
- The JavaScript for error handling
- CSS class names (e.g., `.error-overlay`, `.error-card`)

**Reason**: These are essential for usability when errors occur.

#### **1.3 Pyodide Load Procedure**
```html
<script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
```

**Reason**: This is the foundational runtime for executing Python in the browser.

### **üü° Level 2: Mandatory Rules (You Must Follow These)**

#### **2.1 Python Code Indentation Rules**
```python
# ‚úÖ Correct (starts at the leftmost column)
from docx import Document
import base64

# ‚ùå Incorrect (indented ‚Üí will raise IndentationError)
    from docx import Document
    import base64
```

**Reason**: Don't let HTML indentation leak into Python code; it causes runtime errors.

#### **2.2 Required Imports**
```python
from docx import Document
from io import BytesIO
import base64
import js  # Required for JS ‚Üî Python interop
```

**If omitted, you'll get**: `NameError: name 'js' is not defined`

#### **2.3 Passing Base64 Data**
Always execute the following at the end of your Python code:
```python
js.docx_base64_data = docx_base64
```

**Reason**: This is how JavaScript receives the DOCX data from Python.

### **üü¢ Level 3: Customizable Elements**

You may freely change the following:
- Page title (`<title>` tag and the `<h1>` heading)
- The document content generated by the Python code
- Document styles and layout
- Downloaded filename
- The placement and content of placeholders (when using them)

---

## **üñºÔ∏è Image Placeholder Feature (Optional)**

### **Policy**
**Image placeholders are completely optional.**
- Do **not** insert placeholders unless the request explicitly mentions images.
- If the user mentions images, create placeholders accordingly.
- Even if image files are attached, treat them as **references** and still use placeholders (do not embed images directly).
- The default is a clean, text-only document.

### **Why Use Placeholders?**
- **Smaller HTML files**: stays in kilobytes (versus megabytes if embedding images)
- **Saves context window**: avoids overflowing the AI's token limit
- **Flexible**: images can be swapped in later
- **Shareable**: easy reuse across collaborators
- **Copyright**: avoids rights issues from inline embedding

### **When to Use Placeholders**
Insert placeholders only when the request includes:

1. **Explicit image requests**
   - "add an image," "place a photo," "insert a logo"
   - "insert a diagram," "place a chart," "add an illustration"
   
2. **Attached image files**
   - When images are attached, create placeholders using the filenames
   - Treat attachments as references only (no direct embedding)

3. **Clear mention of visual elements**
   - "add visuals," "include a diagram," etc.

### **When *Not* to Use Placeholders**
- Generic requests like "create a document," "prepare a report"
- No mention of images
- Instructions like "text only," "keep it simple"
- When text alone is sufficient

### **What to Include in a Placeholder**
When using placeholders, include:
1. **Suggested filename or description** (e.g., `logo.png`, `main visual`)
2. **Placement** (e.g., "header‚Äîtop right," "center of body," "left side")
3. **Suggested size** (e.g., `600√ó400 px`, `3√ó2 inches`)
4. **Intended use** (e.g., "company logo," "explanatory diagram," "chart")
5. **Caption idea** (e.g., "Fig. 1: System Architecture")

### **Recommended Placement Patterns (when used)**
| Document Type | Image Type | Recommended Position | Recommended Size |
|---|---|---|---|
| Report | Logo | Header, top right | 2√ó1 inches |
| Report | Cover image | Below title | 6√ó4 inches |
| Manual | Screenshot | After the step description | 5√ó3 inches |
| Proposal | Product photo | In the section body | 4√ó3 inches |
| Contract | Company seal | Footer | 1√ó1 inches |

---

## **üìù HTML Template (Full Version)**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Customizable: Page title -->
    <title>Download Word Document</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Error overlay (DO NOT MODIFY) */
        .error-overlay { position: fixed; inset: 0; background: rgba(17,24,39,0.25); display: none; align-items: center; justify-content: center; padding: 16px; z-index: 9999; }
        .error-card { width: 100%; max-width: 880px; background: rgba(255,255,255,0.96); border: 1px solid rgba(55,65,81,0.25); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); padding: 20px; }
        .error-title { display:flex; align-items:center; gap:8px; font-weight:800; font-size:18px; color:#991b1b; }
        .error-subtitle { margin-top:6px; color:#374151; line-height:1.55; }
        .error-actions { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
        .copy-btn { border:1px solid rgba(55,65,81,.3); padding:8px 12px; border-radius:10px; font-weight:600; background:#fff; cursor: pointer; }
        .copy-btn:hover { background: #f3f4f6; }
        .error-pre { margin-top:12px; background:#0b1020; color:#e5e7eb; border-radius:12px; padding:12px 14px; max-height:320px; overflow:auto; white-space:pre-wrap; word-break:break-word; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,'Courier New',monospace; font-size:13px; line-height:1.45; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="bg-white rounded-2xl shadow-lg p-8 sm:p-12 text-center max-w-md w-full">
        <!-- Customizable: Heading -->
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">
            Word Document
        </h1>

        <p id="status-message" class="text-gray-600 mb-6 h-12 flex items-center justify-center">
            Preparing your file...
        </p>

        <div id="loading-spinner" class="spinner mx-auto mb-6"></div>

        <button id="download-button" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105" disabled>
            Download File
        </button>
    </div>

    <!-- Customizable: Python code (follow the rules) -->
    <script type="text/python" id="python-code">
from docx import Document
from io import BytesIO
import base64
import js

# Create document
doc = Document()

# Title
doc.add_heading('Document generated automatically by AI', 0)

# Paragraphs
doc.add_paragraph('This Word document was created dynamically.')

# Save to BytesIO
docx_io = BytesIO()
doc.save(docx_io)
docx_io.seek(0)

# Base64 encode
docx_bytes = docx_io.read()
docx_base64 = base64.b64encode(docx_bytes).decode('utf-8')

# Pass to JavaScript (required)
js.docx_base64_data = docx_base64

print("DOCX file has been generated in memory.")
    </script>

    <!-- Error overlay (DO NOT MODIFY) -->
    <div id="error-overlay" class="error-overlay" role="dialog" aria-modal="true" aria-labelledby="error-title">
        <div class="error-card">
            <div class="error-title" id="error-title">An error occurred: Please paste the message below into your AI chat and ask for a fix</div>
            <div class="error-subtitle">Copy the full error and send it to your AI assistant. It will identify the cause and propose a patch.</div>
            <div class="error-actions">
                <button id="copy-error" class="copy-btn" aria-label="Copy error message">Copy full error</button>
                <button id="close-error" class="copy-btn" aria-label="Close this error dialog">Close</button>
            </div>
            <pre id="error-text" class="error-pre" tabindex="0" aria-live="polite"></pre>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <script type="module">
        const statusMessage = document.getElementById('status-message');
        const downloadButton = document.getElementById('download-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const overlay = document.getElementById('error-overlay');
        const errorText = document.getElementById('error-text');
        const copyBtn = document.getElementById('copy-error');
        const closeBtn = document.getElementById('close-error');

        // Error UI handlers
        copyBtn?.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(errorText.textContent || '');
                copyBtn.textContent = 'Copied';
                setTimeout(() => (copyBtn.textContent = 'Copy full error'), 1200);
            } catch (_) {
                const r = document.createRange(); 
                r.selectNodeContents(errorText);
                const sel = window.getSelection(); 
                sel.removeAllRanges(); 
                sel.addRange(r);
            }
        });

        closeBtn?.addEventListener('click', () => { 
            overlay.style.display = 'none'; 
        });

        async function main() {
            try {
                statusMessage.textContent = 'Loading runtime...';
                const pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/",
                });

                // Install python-docx (DO NOT REMOVE)
                statusMessage.textContent = 'Installing libraries...';
                await pyodide.loadPackage("micropip");
                await pyodide.runPythonAsync(`
                    import micropip
                    await micropip.install('python-docx')
                `);

                statusMessage.textContent = 'Generating file...';
                const pythonCode = document.getElementById('python-code').textContent;
                window.docx_base64_data = null; 
                await pyodide.runPythonAsync(pythonCode);
                const base64Data = window.docx_base64_data;

                if (!base64Data) {
                    throw new Error("Python code did not produce any data.");
                }

                statusMessage.textContent = 'Ready!';
                loadingSpinner.style.display = 'none';
                downloadButton.disabled = false;
                downloadButton.addEventListener('click', () => downloadFile(base64Data, 'document.docx'));

            } catch (error) {
                console.error("An error occurred:", error);
                
                try {
                    const details = (error && (error.stack || error.message || String(error))) || 'Unknown error';
                    errorText.textContent = details.trim();
                } catch(_) {
                    errorText.textContent = 'Unknown error';
                }
                
                overlay.style.display = 'flex';
                statusMessage.textContent = 'Process aborted.';
                loadingSpinner.style.display = 'none';
            }
        }

        function downloadFile(base64Data, fileName) {
            try {
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }, 100);

            } catch (error) {
                console.error("Download failed:", error);
                statusMessage.textContent = 'Download failed.';
            }
        }

        window.onload = main;
    </script>
</body>
</html>
```

---

## **üîß Error Diagnosis Guide**

### **Common Errors and Fixes**

#### **1. ModuleNotFoundError**
```
ModuleNotFoundError: No module named 'docx'
```
**Cause**: The installation process for `python-docx` was removed.  
**Fix**: Restore `await micropip.install('python-docx')`.

#### **2. IndentationError**
```
IndentationError: unexpected indent
```
**Cause**: Python code doesn't start at the leftmost column.  
**Fix**: Remove all unintended indentation from the Python code.

#### **3. NameError**
```
NameError: name 'js' is not defined
```
**Cause**: `import js` is missing.  
**Fix**: Add `import js` to the required imports.

#### **4. AttributeError**
```
AttributeError: 'Document' object has no attribute 'add_heading'
```
**Cause**: Incorrect use of the `python-docx` API.  
**Fix**: Use correct method names (e.g., `add_heading`, `add_paragraph`).

### **What to Do When an Error Occurs (4 Steps)**

1. **Auto Display**: A full-screen error overlay appears.  
   - High-visibility design that's hard to miss  
   - Full details (stack trace) are shown

2. **One-Click Copy**: Click **"Copy full error."**  
   - Automatically copies to the clipboard  
   - Shows a "Copied" confirmation

3. **Paste to AI**: Paste directly into your chat with an AI assistant.  
   - The AI analyzes the error contents  
   - Identifies the root cause

4. **Resolve**: Use the fix suggested by the AI.  
   - Clear explanation of what to change  
   - Provides corrected code

---

## **üí° Implementation Examples**

### **Level 1: Minimal Implementation (No Images)**
```python
# Default behavior: no image placeholders
from docx import Document
from io import BytesIO
import base64
import js

doc = Document()
doc.add_heading('Simple Document', 0)
doc.add_paragraph('This is a basic paragraph.')
doc.add_paragraph('This document consists of text only.')

# Save
docx_io = BytesIO()
doc.save(docx_io)
docx_io.seek(0)
js.docx_base64_data = base64.b64encode(docx_io.read()).decode('utf-8')
```

### **Level 2: Basic Document Structure (No Images)**
```python
from docx import Document
from docx.shared import Pt, Inches
from docx.enum.text import WD_ALIGN_PARAGRAPH
from io import BytesIO
import base64
import js

doc = Document()

# Title
doc.add_heading('Monthly Work Report', 0)
doc.add_heading('January 2025', level=1)

# Summary
doc.add_heading('Summary', level=2)
doc.add_paragraph('This report covers the work performed this month.')

# Bulleted list
doc.add_heading('Tasks Completed', level=2)
doc.add_paragraph('Data analysis', style='List Bullet')
doc.add_paragraph('Report writing', style='List Bullet')
doc.add_paragraph('Meetings', style='List Bullet')

# Numbered list
doc.add_heading('Next Steps', level=2)
doc.add_paragraph('Finish requirements definition', style='List Number')
doc.add_paragraph('Prepare design docs', style='List Number')
doc.add_paragraph('Start implementation', style='List Number')

# Table
doc.add_heading('Progress', level=2)
table = doc.add_table(rows=4, cols=3)
table.style = 'Light Grid Accent 1'

# Header row
hdr_cells = table.rows[0].cells
hdr_cells[0].text = 'Task'
hdr_cells[1].text = 'Progress'
hdr_cells[2].text = 'Status'

# Data rows
data = [
    ('Analysis', '100%', 'Done'),
    ('Design', '60%', 'In Progress'),
    ('Implementation', '0%', 'Not Started')
]

for i, (task, progress, status) in enumerate(data, 1):
    row_cells = table.rows[i].cells
    row_cells[0].text = task
    row_cells[1].text = progress
    row_cells[2].text = status

# Save
docx_io = BytesIO()
doc.save(docx_io)
docx_io.seek(0)
js.docx_base64_data = base64.b64encode(docx_io.read()).decode('utf-8')
```

### **Level 3: Optional ‚Äì With Image Placeholders (Only if Explicitly Requested)**
```python
# Use only when the user explicitly says "please place images", etc.
from docx import Document
from docx.shared import Inches, Pt, RGBColor
from docx.enum.text import WD_ALIGN_PARAGRAPH
from docx.oxml import parse_xml
from docx.oxml.ns import nsdecls
from io import BytesIO
import base64
import js

def add_image_placeholder(doc, position_text, size_text, description):
    """Adds an image placeholder (optional feature)."""
    # Create a one-cell table as a placeholder
    table = doc.add_table(rows=1, cols=1)
    table.style = 'Table Grid'
    cell = table.cell(0, 0)
    cell.text = description
    
    # Set background shading
    shading_elm = parse_xml(r'<w:shd {} w:fill="F0F0F0"/>'.format(nsdecls('w')))
    cell._element.get_or_add_tcPr().append(shading_elm)
    
    return table

doc = Document()

# Header (when the user requests a logo)
# Example: The request says "Please place a logo."
p = doc.add_paragraph()
p.alignment = WD_ALIGN_PARAGRAPH.RIGHT
run = p.add_run('[Logo Insertion Point]')
run.bold = True
run.font.size = Pt(8)
run.font.color.rgb = RGBColor(150, 150, 150)
p.add_run('\nlogo.png (2√ó1 inches)')

# Main title
doc.add_heading('Product Proposal', 0)

# Cover image placeholder (when requested)
# Example: The request says "Please include a cover image."
add_image_placeholder(
    doc,
    "Below Title",
    "6√ó4 inches",
    '[Cover Image Placeholder]\ncover_image.jpg\nRecommended: 6√ó4 inches\nMain visual to convey the product\'s appeal'
)

doc.add_page_break()

# Body
doc.add_heading('1. Product Overview', level=1)
doc.add_paragraph('This section describes the product.')

# Product image placeholder (when requested)
# Example: The request says "Please place a product photo."
doc.add_paragraph()
p = doc.add_paragraph('[Fig. 1: Product Image]')
p.alignment = WD_ALIGN_PARAGRAPH.CENTER
run = p.runs[0]
run.bold = True
run.font.color.rgb = RGBColor(0, 100, 200)

add_image_placeholder(
    doc,
    "Centered in body",
    "4√ó3 inches",
    'product_image.png\nRecommended: 4√ó3 inches\nProduct appearance'
)

doc.add_heading('2. Features', level=1)
doc.add_paragraph('‚Ä¢ High performance', style='List Bullet')
doc.add_paragraph('‚Ä¢ Low cost', style='List Bullet')
doc.add_paragraph('‚Ä¢ Easy to use', style='List Bullet')

# Save
docx_io = BytesIO()
doc.save(docx_io)
docx_io.seek(0)
js.docx_base64_data = base64.b64encode(docx_io.read()).decode('utf-8')
```

### **Level 4: Advanced ‚Äì Conditional Logic**
```python
from docx import Document
from docx.shared import Inches, Pt, RGBColor, Cm
from docx.enum.text import WD_ALIGN_PARAGRAPH
from docx.enum.style import WD_STYLE_TYPE
from docx.enum.section import WD_SECTION
from docx.oxml import parse_xml
from docx.oxml.ns import nsdecls
from io import BytesIO
import base64
import js

def should_add_image_placeholder(user_request):
    """Returns True if the user request includes explicit instructions for images."""
    
    # Image-related keywords
    image_keywords = [
        'image', 'photo', 'picture', 'logo', 'diagram',
        'graph', 'chart', 'illustration', 'visual'
    ]
    
    # Explicit instruction patterns
    explicit_patterns = ['add', 'place', 'insert', 'slot', 'area']
    
    # Default is False (no images)
    request_lower = user_request.lower() if user_request else ""
    
    for keyword in image_keywords:
        if keyword in request_lower:
            for pattern in explicit_patterns:
                if pattern in request_lower:
                    return True
    
    return False

def add_image_placeholder_if_needed(doc, description, user_wants_image):
    """Adds a placeholder conditionally."""
    if user_wants_image:
        table = doc.add_table(rows=1, cols=1)
        table.style = 'Table Grid'
        cell = table.cell(0, 0)
        cell.text = description
        
        # Background shading
        shading_elm = parse_xml(r'<w:shd {} w:fill="E6F2FF"/>'.format(nsdecls('w')))
        cell._element.get_or_add_tcPr().append(shading_elm)
        
        return table
    return None

# Example user request (in practice, determined by the AI layer)
user_request = "Please prepare a technical specification."  # No images
# user_request = "Please prepare a technical specification with a logo."  # Images

# Decide whether to add image placeholders
add_images = should_add_image_placeholder(user_request)

doc = Document()

# Page setup
section = doc.sections[0]
section.page_height = Cm(29.7)  # A4
section.page_width = Cm(21.0)   # A4
section.left_margin = Cm(2.5)
section.right_margin = Cm(2.5)
section.top_margin = Cm(2.5)
section.bottom_margin = Cm(2.5)

# Custom style
styles = doc.styles
heading_style = styles.add_style('CustomHeading', WD_STYLE_TYPE.PARAGRAPH)
heading_style.font.name = 'Meiryo'
heading_style.font.size = Pt(14)
heading_style.font.bold = True
heading_style.font.color.rgb = RGBColor(0, 51, 102)

# Cover
title = doc.add_paragraph('Technical Specification', style='CustomHeading')
title.alignment = WD_ALIGN_PARAGRAPH.CENTER
title.runs[0].font.size = Pt(24)

subtitle = doc.add_paragraph('Version 1.0')
subtitle.alignment = WD_ALIGN_PARAGRAPH.CENTER

# Date
date_p = doc.add_paragraph('January 2025')
date_p.alignment = WD_ALIGN_PARAGRAPH.CENTER

# Conditionally add a logo placeholder
add_image_placeholder_if_needed(
    doc,
    '[Company Logo]\ncompany_logo.png\n3√ó2 inches\nCentered',
    user_wants_image=add_images
)

doc.add_page_break()

# Table of Contents
doc.add_heading('Table of Contents', level=1)
p = doc.add_paragraph('1. Introduction ... 3')
p = doc.add_paragraph('2. Specifications ... 4')
p = doc.add_paragraph('3. Technical Details ... 5')

doc.add_page_break()

# Section 1
doc.add_heading('1. Introduction', level=1)
doc.add_paragraph('This document describes the product\'s technical specifications.')

# Section 2
doc.add_heading('2. Specifications', level=1)
table = doc.add_table(rows=5, cols=4)
table.style = 'Medium Grid 1 Accent 1'

# Header row (merged)
table.cell(0, 0).merge(table.cell(0, 3))
table.cell(0, 0).text = 'Product Specifications'

# Sub-headers
headers = ['Item', 'Spec', 'Notes', 'Ref']
for idx, header in enumerate(headers):
    table.cell(1, idx).text = header

# Data
specs = [
    ('Size', '100√ó50√ó30 mm', '¬±2 mm', 'See Fig. 1'),
    ('Weight', '500 g', '¬±10 g', '-'),
    ('Operating Temp.', '-10 to 50‚ÑÉ', 'No condensation', 'See test data')
]

for i, (item, spec, note, ref) in enumerate(specs, 2):
    table.cell(i, 0).text = item
    table.cell(i, 1).text = spec
    table.cell(i, 2).text = note
    table.cell(i, 3).text = ref

# Conditionally add a diagram placeholder
if add_images:
    doc.add_paragraph()
    add_image_placeholder_if_needed(
        doc,
        '[Fig. 1: Product Dimensions]\ndimensions.png\n5√ó4 inches\nExported from CAD',
        user_wants_image=add_images
    )

# New section
doc.add_section(WD_SECTION.NEW_PAGE)

# Appendix
doc.add_heading('Appendix A: Test Data', level=1)

# Conditionally add a chart placeholder
add_image_placeholder_if_needed(
    doc,
    '[Test Data Chart]\ntest_results.png\n6√ó4 inches\nResults of temperature tests',
    user_wants_image=add_images
)

# Footer notice
doc.add_paragraph()
doc.add_paragraph()
p = doc.add_paragraph()
p.alignment = WD_ALIGN_PARAGRAPH.CENTER
run = p.add_run('Confidential ‚Äì Handle with care')
run.font.size = Pt(9)
run.font.color.rgb = RGBColor(128, 128, 128)

# Save
docx_io = BytesIO()
doc.save(docx_io)
docx_io.seek(0)
js.docx_base64_data = base64.b64encode(docx_io.read()).decode('utf-8')
```

---

## **üìö Word-Specific Features**

### **Page Setup**
```python
from docx.shared import Cm
section = doc.sections[0]
section.page_height = Cm(29.7)  # A4 portrait
section.page_width = Cm(21.0)
section.left_margin = Cm(2.5)
section.right_margin = Cm(2.5)
section.top_margin = Cm(2.5)
section.bottom_margin = Cm(2.5)
section.orientation = WD_ORIENT.LANDSCAPE  # Landscape
```

### **Style Management**
```python
# Create a custom style
styles = doc.styles
custom_style = styles.add_style('MyStyle', WD_STYLE_TYPE.PARAGRAPH)
custom_style.font.name = 'Meiryo'
custom_style.font.size = Pt(12)
custom_style.font.bold = True

# Apply the style
p = doc.add_paragraph('Styled text', style='MyStyle')
```

### **Section Breaks**
```python
from docx.enum.section import WD_SECTION
# New section starting on a new page
doc.add_section(WD_SECTION.NEW_PAGE)
# Continuous section (on the same page)
doc.add_section(WD_SECTION.CONTINUOUS)
```

### **Header & Footer**
```python
# Header
header = doc.sections[0].header
header_p = header.paragraphs[0]
header_p.text = "Document Title"
header_p.alignment = WD_ALIGN_PARAGRAPH.CENTER

# Footer
footer = doc.sections[0].footer
footer_p = footer.paragraphs[0]
footer_p.text = "Page number: "
footer_p.alignment = WD_ALIGN_PARAGRAPH.CENTER
```

### **Advanced Table Operations**
```python
# Merge cells
table.cell(0, 0).merge(table.cell(0, 2))

# Paragraph formatting inside a cell
cell = table.cell(0, 0)
cell.paragraphs[0].alignment = WD_ALIGN_PARAGRAPH.CENTER

# Set row height
from docx.oxml import OxmlElement
from docx.oxml.ns import qn
tr = table.rows[0]._tr
trPr = tr.get_or_add_trPr()
trHeight = OxmlElement('w:trHeight')
trHeight.set(qn('w:val'), '1000')  # Height in twips
trPr.append(trHeight)
```

---

## **‚úÖ Implementation Checklist**

### **Mandatory Checks**
- [ ] The `python-docx` installation step exists
- [ ] Python code starts at the leftmost column
- [ ] `import js` is present
- [ ] There is an assignment to `js.docx_base64_data`
- [ ] The error overlay HTML is intact

### **Placeholder Checks**
- [ ] Do **not** place image placeholders by default
- [ ] No direct image embedding (mandatory)
- [ ] Placeholders only when the user explicitly asks for images
- [ ] Treat attached images as placeholders (not embedded)
- [ ] Placeholders include the required information (when used)

### **Behavior Checks**
- [ ] Page loads successfully
- [ ] Download button becomes enabled
- [ ] The DOCX downloads successfully
- [ ] Error overlay appears on failure
- [ ] Copy-error button works

---

## **üìä `python-docx` Reference**

### **Add Document Elements**
| Method | Purpose | Example |
|---|---|---|
| `add_heading(text, level)` | Add a heading | `doc.add_heading('Title', 0)` |
| `add_paragraph(text, style)` | Add a paragraph | `doc.add_paragraph('Body')` |
| `add_table(rows, cols)` | Add a table | `doc.add_table(3, 4)` |
| `add_page_break()` | Page break | `doc.add_page_break()` |
| `add_section(start_type)` | Section break | `doc.add_section()` |

### **Text Formatting**
```python
# Get a paragraph and format runs
p = doc.add_paragraph()
run = p.add_run('Text')
run.bold = True
run.italic = True
run.underline = True
run.font.size = Pt(12)
run.font.name = 'Meiryo'
run.font.color.rgb = RGBColor(255, 0, 0)

# Paragraph alignment
p.alignment = WD_ALIGN_PARAGRAPH.CENTER   # Center
p.alignment = WD_ALIGN_PARAGRAPH.RIGHT    # Right
p.alignment = WD_ALIGN_PARAGRAPH.JUSTIFY  # Justify
```

### **Units**
```python
from docx.shared import Inches, Pt, Cm, Mm

# Inches
width = Inches(3)  # 3 inches

# Points (e.g., font size)
size = Pt(12)  # 12 pt

# Centimeters
margin = Cm(2.5)  # 2.5 cm

# Millimeters
spacing = Mm(10)  # 10 mm
```

---

## **üöÄ Quick Start**

### **Fastest Path (3 Steps)**

1. **Copy the HTML template**
2. **Change the title** (both `<title>` and `<h1>`)
3. **Define your document content in Python**

```python
# Minimal changes (simple text-only document)
doc = Document()
doc.add_heading('Put your title here', 0)
doc.add_paragraph('Write your body text here.')
# ... then save as shown in the template
```

### **When Images Are Needed**

Only when the user explicitly requests images:

1. **Place a placeholder**
```python
# For a request like "Please place an image."
table = doc.add_table(rows=1, cols=1)
table.style = 'Table Grid'
table.cell(0, 0).text = '[Image]\nPlace the image here.'
```

2. **User adds the actual image in Word**
   - Open the downloaded DOCX
   - Remove the placeholder
   - Insert the real image via **Insert ‚Üí Pictures**

---

## **üìù Changelog**

- **v4.0** (2025-09-17)
  - Changed image placeholders to an **optional** feature
  - No placeholders are placed by default
  - Placeholders are created only when explicitly requested
  - Even with attachments, always treat images as placeholders (no direct embedding)
  - Adopted the same design philosophy as `XLSX-RECIPE.md` for CSV handling

- **v3.0** (2025-09-17)
  - Reorganized implementation rules by priority
  - Clarified image handling (all via placeholders)
  - Added full-screen error UI overlay
  - Expanded to 4 levels of implementation examples
  - Added advanced Word features
  - Included complete error-handling steps

- **v2.1** (2025-09-17)
  - Emphasized the importance of installing external libraries
  - Added an image placeholder feature

- **v2.0** (2025-09-17)
  - Image placement suggestions
  - Clearer guidance to prevent indentation errors

---

## **üìÑ License**

MIT License ‚Äì free to use, modify, redistribute, and for commercial use.

---

## **üÜò Support**

### **If You Encounter Problems**

1. **Copy the error message**
   - Use the "Copy full error" button in the overlay

2. **Ask an AI for help**
   - Paste the error into your chat with the AI
   - It will analyze the cause and propose a fixed version

3. **Check the checklist**
   - Make sure mandatory items aren't missing
   - Pay special attention to the `python-docx` installation step

4. **Refer to the examples**
   - Start with the Level 1 minimal example
   - Add features step by step

### **FAQ**

**Q: How do I add images?**  
A: If you need images, explicitly say "Please place images." By default, no placeholders are inserted.

**Q: I want the old behavior that automatically created image spaces.**  
A: Say "Include image placeholders," and it will work like v3.x.

**Q: I attached image files, but they weren't embedded.**  
A: By design, images are always handled via placeholders. This keeps files small and lets you change images later.

**Q: Can I change how placeholders look?**  
A: Yes. Customize table styles or background shading via `table.style` and `shading_elm`.

**Q: I need vertical writing.**  
A: `python-docx` does not directly support vertical text. Set it manually in Word after opening the file.

**Q: Can I auto-generate a Table of Contents?**  
A: Place the heading structure and then use Word's Table of Contents feature. Heading styles will be recognized automatically.

---

## **Migration Guide (v3.x ‚Üí v4.0)**

### **Key Changes**
- Image placeholders are no longer placed by default.
- If you need images, explicitly request to "place images," etc.

### **Compatibility**
- Want the same behavior as before? Say "Include image placeholders."  
- Want a clean, simple document? No special instructions needed (this is the new default).

### **Benefits**
- Cleaner, simpler default documents
- Image spaces added only when needed
- Consistently small file sizes

---

**This is the full text of Recipe v4.0. It includes detailed explanations and examples so that AI can correctly interpret the instructions and build a DOCX download page aligned with the user's intent.**
